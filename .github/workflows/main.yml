name: Linux VPS Setup

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install Dependencies
      run: sudo apt update && sudo apt install -y wget unzip openssh-server

    - name: Download Ngrok
      run: wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -O ngrok.zip

    - name: Extract Ngrok
      run: unzip ngrok.zip

    - name: Authenticate Ngrok
      run: ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Create SSH User with Password
      run: |
        # Create the user if it doesn't exist
        if id "runneradmin" &>/dev/null; then
          echo "User runneradmin already exists"
        else
          sudo useradd -m -s /bin/bash runneradmin
        fi
        
        # Set password for the user
        echo "runneradmin:P@ssw0rd!" | sudo chpasswd
        
        # Allow password authentication
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/#PasswordAuthentication no/' /etc/ssh/sshd_config
        
        # Allow the user to login
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
        echo "AllowUsers runneradmin" | sudo tee -a /etc/ssh/sshd_config

    - name: Start SSH Service
      run: |
        sudo systemctl start ssh
        sudo systemctl enable ssh
        sudo systemctl restart ssh

    - name: Create SSH Tunnel with Ngrok
      run: |
        # Run ngrok in background and get tunnel URL
        ./ngrok tcp 22 --log stdout > ngrok.log &
        sleep 5
        
        # Extract and display the connection information
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*"' | cut -d'"' -f4)
        echo "=========================================="
        echo "SSH Connection Details:"
        echo "Host: $(echo $NGROK_URL | cut -d':' -f2 | sed 's#//##')"
        echo "Port: $(echo $NGROK_URL | cut -d':' -f3)"
        echo "Username: runneradmin"
        echo "Password: P@ssw0rd!"
        echo "=========================================="
        
        # Keep the workflow running
        sleep 300
